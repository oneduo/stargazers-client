import { ImageResponse } from "@vercel/og"
import { NextRequest } from "next/server"
import client from "@/utils/apollo"
import { Package, Stargazer } from "@/generated/graphql"
import SESSION_QUERY from "@/graphql/session"

export const config = {
  runtime: "experimental-edge",
}

export default async function og(req: NextRequest) {
  try {
    const { searchParams } = new URL(req.url)

    const session = searchParams.get("session")

    const { data } = await client.query<{ session: { stargazer?: Stargazer; packages: Package[] } }>({
      query: SESSION_QUERY,
      variables: {
        session: session,
      },
    })

    return new ImageResponse(
      (
        <div
          style={{
            height: "100%",
            width: "100%",
            display: "flex",
            flexDirection: "column",
            alignItems: "center",
            justifyContent: "center",
          }}
        >
          <div tw="flex bg-zinc-900 h-full border-[15px] border-emerald-500">
            <div tw="flex flex-col h-full w-full items-center p-20">
              <svg tw="my-6" viewBox="0 0 252 52" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M16.1672 29.0725C16.0032 29.8926 14.4724 30.2206 13.8163 30.2753C10.864 30.5486 8.18501 28.5257 6.21679 26.5575L0.530834 31.5874C3.37381 35.0865 8.02099 37.4921 12.5588 37.4921C17.534 37.4921 23.384 35.1411 24.0947 29.5645C24.9695 22.8398 18.2994 20.7622 13.6523 18.466C12.7228 18.0286 9.00509 16.4978 9.16911 15.295C9.22379 14.8576 9.66117 14.5295 9.9892 14.3655C10.6999 13.9828 11.5747 13.9281 12.3401 13.9828C14.6364 14.2015 16.3312 15.3496 17.698 17.1538L23.4933 12.1786C20.705 8.78891 16.7139 6.76603 12.3401 6.76603C7.47426 6.76603 2.44438 8.95293 1.35092 14.1468C0.913543 16.4431 1.56961 18.794 3.04578 20.5982C4.57661 22.5664 8.51304 24.1519 10.8093 25.1907C11.7934 25.7374 16.3859 27.815 16.1672 29.0725ZM32.578 26.0108V13.7641H40.2868V7.25808H32.578V0.314655H25.1425V27.7057C25.1425 32.4622 28.0401 35.8519 32.1953 37.0547C34.8742 37.8748 37.7719 37.3827 40.2868 36.836V30.0566C35.749 31.4781 32.1406 30.494 32.578 26.0108ZM47.0983 22.129C47.0983 17.7552 50.652 14.2015 55.0258 14.2015C59.3996 14.2015 62.8987 17.7552 62.8987 22.129C62.8987 26.5029 59.3996 30.0566 55.0258 30.0566C50.652 30.0566 47.0983 26.5029 47.0983 22.129ZM39.6628 22.129C39.6628 30.6033 46.4969 37.4921 55.0258 37.4921C55.9552 37.4921 56.83 37.4374 57.7594 37.2734L62.8987 34.2664V37H70.3888V7.25808H62.8987V9.99171L57.7594 6.98472C56.83 6.87537 55.9552 6.76603 55.0258 6.76603C46.4969 6.76603 39.6628 13.6548 39.6628 22.129ZM80.4712 9.99171V7.25808H73.0357V37H80.4712V21.473C80.4712 14.3655 87.524 12.1786 92.1165 15.7323L93.5926 8.0235C91.7884 7.20341 89.8202 6.76603 87.688 6.76603C87.0866 6.76603 86.4305 6.8207 85.8291 6.87537L80.4712 9.99171ZM105.653 35.2505C105.872 35.2505 106.09 35.2505 106.309 35.2505C113.799 35.2505 119.923 29.4552 120.469 22.0744H120.524V7.25808H113.089V9.99171L107.567 6.8207C107.184 6.76603 106.747 6.76603 106.309 6.76603C98.4363 6.76603 92.0396 13.1627 92.0396 21.0356C92.0396 25.7921 94.3359 30.0019 97.9442 32.5715L96.9601 33.1729L92.5317 35.6879C88.0485 51.2149 111.23 46.9504 118.939 45.0916V37C115.166 38.0388 99.3657 41.9205 99.3657 37C99.3657 35.9612 100.569 35.2505 101.662 35.2505H105.653ZM106.309 27.815C102.537 27.815 99.4751 24.7533 99.4751 21.0356C99.4751 17.2632 102.537 14.2015 106.309 14.2015C110.027 14.2015 113.089 17.2632 113.089 21.0356C113.089 24.7533 110.027 27.815 106.309 27.815ZM128.43 22.129C128.43 17.7552 131.984 14.2015 136.358 14.2015C140.732 14.2015 144.231 17.7552 144.231 22.129C144.231 26.5029 140.732 30.0566 136.358 30.0566C131.984 30.0566 128.43 26.5029 128.43 22.129ZM120.995 22.129C120.995 30.6033 127.829 37.4921 136.358 37.4921C137.287 37.4921 138.162 37.4374 139.091 37.2734L144.231 34.2664V37H151.721V7.25808H144.231V9.99171L139.091 6.98472C138.162 6.87537 137.287 6.76603 136.358 6.76603C127.829 6.76603 120.995 13.6548 120.995 22.129ZM153.001 14.6936H165.302L153.548 32.5168L153.11 33.1729L153.001 33.3369V37H176.729V29.5645H164.427L176.565 11.1398L176.729 10.9211V7.25808H153.001V14.6936ZM191.558 6.76603C183.029 6.76603 176.195 13.6548 176.195 22.129C176.195 30.6033 183.029 37.4921 191.558 37.4921C198.392 37.4921 204.187 33.0089 206.156 26.8856H197.9C196.424 28.7991 194.128 30.0566 191.558 30.0566C188.114 30.0566 185.161 27.8697 184.068 24.7533H206.648C206.812 23.9332 206.921 23.0585 206.921 22.129C206.921 13.6548 200.032 6.76603 191.558 6.76603ZM184.614 18.302C185.981 15.8417 188.551 14.2015 191.558 14.2015C194.51 14.2015 197.08 15.8417 198.447 18.302H184.614ZM215.562 9.99171V7.25808H208.126V37H215.562V21.473C215.562 14.3655 222.615 12.1786 227.207 15.7323L228.683 8.0235C226.879 7.20341 224.911 6.76603 222.779 6.76603C222.177 6.76603 221.521 6.8207 220.92 6.87537L215.562 9.99171ZM243.078 29.0725C242.914 29.8926 241.383 30.2206 240.727 30.2753C237.775 30.5486 235.096 28.5257 233.127 26.5575L227.442 31.5874C230.285 35.0865 234.932 37.4921 239.47 37.4921C244.445 37.4921 250.295 35.1411 251.005 29.5645C251.88 22.8398 245.21 20.7622 240.563 18.466C239.634 18.0286 235.916 16.4978 236.08 15.295C236.134 14.8576 236.572 14.5295 236.9 14.3655C237.611 13.9828 238.485 13.9281 239.251 13.9828C241.547 14.2015 243.242 15.3496 244.609 17.1538L250.404 12.1786C247.616 8.78891 243.625 6.76603 239.251 6.76603C234.385 6.76603 229.355 8.95293 228.262 14.1468C227.824 16.4431 228.48 18.794 229.956 20.5982C231.487 22.5664 235.424 24.1519 237.72 25.1907C238.704 25.7374 243.297 27.815 243.078 29.0725Z"
                  fill="white"
                />
              </svg>

              <>
                <h2 tw="text-center text-yellow-50 text-4xl font-bold flex-wrap items-center justify-center">
                  {data.session.stargazer?.username ?? "Github User"} just starred{" "}
                  <span tw="text-yellow-500 mx-1">{data.session.packages?.length ?? 0}</span> packages on Github!
                </h2>
              </>

              <span tw="text-emerald-500 text-center font-bold text-2xl my-2">
                Showing appreciation for the amazing open source communities
              </span>
              <div
                tw="text-white mt-20 bg-emerald-800/50 p-8 font-bold text-2xl rounded-lg text-emerald-500 border-4 border-emerald-500 flex items-center"
                style={{ gap: "20px;" }}
              >
                <span>Get started yourself and star them all </span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  style={{ marginLeft: 20 }}
                  viewBox="0 0 24 24"
                  strokeWidth="2"
                  stroke="#10b981"
                  className="ml-6 w-6 h-6"
                >
                  <path strokeLinecap="round" strokeLinejoin="round" d="M17.25 8.25L21 12m0 0l-3.75 3.75M21 12H3" />
                </svg>
              </div>

              <span tw="text-zinc-400 mt-8 font-bold">www.stargazers.app</span>
            </div>

            <svg tw="absolute" viewBox="0 0 600 600" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M232.932 419.723L208 507L183.068 419.723C176.624 397.178 164.542 376.648 147.963 360.068C131.383 343.488 110.852 331.407 88.308 324.963L1 300L88.2773 275.068C110.822 268.624 131.352 256.542 147.932 239.963C164.512 223.383 176.593 202.852 183.037 180.308L208 93L232.932 180.277C239.376 202.822 251.458 223.352 268.037 239.932C284.617 256.512 305.148 268.593 327.692 275.037L415 300L327.723 324.932C305.178 331.376 284.648 343.458 268.068 360.037C251.488 376.617 239.407 397.148 232.963 419.692L232.932 419.723ZM491.943 199.26L484 231L476.057 199.26C471.511 181.062 462.105 164.442 448.844 151.176C435.583 137.91 418.967 128.496 400.771 123.943L369 116L400.771 108.057C418.967 103.504 435.583 94.0905 448.844 80.8244C462.105 67.5583 471.511 50.938 476.057 32.74L484 1L491.943 32.74C496.492 50.9417 505.902 67.5647 519.169 80.8311C532.435 94.0976 549.058 103.508 567.26 108.057L599 116L567.26 123.943C549.058 128.492 532.435 137.902 519.169 151.169C505.902 164.435 496.492 181.058 491.943 199.26ZM450.083 562.721L438 599L425.917 562.721C422.53 552.559 416.823 543.326 409.249 535.751C401.674 528.177 392.441 522.47 382.279 519.083L346 507L382.279 494.917C392.441 491.53 401.674 485.823 409.249 478.249C416.823 470.674 422.53 461.441 425.917 451.279L438 415L450.083 451.279C453.47 461.441 459.177 470.674 466.751 478.249C474.326 485.823 483.559 491.53 493.721 494.917L530 507L493.721 519.083C483.559 522.47 474.326 528.177 466.751 535.751C459.177 543.326 453.47 552.559 450.083 562.721Z"
                stroke="#FFE92620"
                strokeWidth="1.5"
                strokeLinecap="round"
                strokeLinejoin="round"
              />
            </svg>
          </div>
        </div>
      ),
      {
        width: 1200,
        height: 600,
      },
    )
  } catch (e) {
    console.log(`${e.message}`)

    return new Response(`Failed to generate the image`, {
      status: 500,
    })
  }
}
